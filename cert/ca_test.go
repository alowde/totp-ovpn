package cert

import (
	"bytes"
	"fmt"
	"testing"
)

var ca = bytes.NewReader([]byte(`
-----BEGIN CERTIFICATE-----
MIIDZzCCAk+gAwIBAgIJAJ4Jrmm9AWxtMA0GCSqGSIb3DQEBCwUAMEoxCzAJBgNV
BAYTAkFVMQswCQYDVQQIDAJTQTEaMBgGA1UECgwRTG9jYWxob3N0IFB0eSBMdGQx
EjAQBgNVBAMMCWxvY2FsaG9zdDAeFw0xOTAxMjIxMDQ4MTBaFw0yOTAxMTkxMDQ4
MTBaMEoxCzAJBgNVBAYTAkFVMQswCQYDVQQIDAJTQTEaMBgGA1UECgwRTG9jYWxo
b3N0IFB0eSBMdGQxEjAQBgNVBAMMCWxvY2FsaG9zdDCCASIwDQYJKoZIhvcNAQEB
BQADggEPADCCAQoCggEBAKXl2JorJoZViXn1Kgw3yOwlvmdnk+6aquzqmy3ZkYWs
/EJc/kORIk96ZXO8mMXEgof6kVyiV3iQybOlMFb5cHzdSFdH+VKduvNVLDybQ5WW
/fBidJa7BGDtUCFSaSBV9PD08dOBQ1VSWm5aKGBWhlvi/nnYJ2VMfy3ogfUCSCf+
aYj7K4+z8BSYzEoaIjR3z5rYR2Q3EfzVxBcOBKgXdzZNNt0G1APzyBQVXqrjrjzJ
hsJAQZcCzRNCeD+Fv/4tafvTyzmpbmCA4pBmM7VNp8QOt+wtTlAgR/rcWAxLxHQZ
HLFtL4HoA/OqK98iCyItZSXCOxk4TK9NRVH5GWmbv4kCAwEAAaNQME4wHQYDVR0O
BBYEFFEcJPevqRtumkXMH2wrQ/JDSAP4MB8GA1UdIwQYMBaAFFEcJPevqRtumkXM
H2wrQ/JDSAP4MAwGA1UdEwQFMAMBAf8wDQYJKoZIhvcNAQELBQADggEBABdF9FF1
v5J56O5Igf6nbxX6nSum0X27MlA0e9xyxeHPq1WMCGv6aMAHqZwSRAakf7x4nUw5
8X+a0hpD8bcP5QLhjq5pHnwPHlxy6Nr6qt/zCv68sj+jKPFnj8kVGGsasjWXmrRj
ALc+beIUNsqJlk17cNCKoTwdtWaH/U8Kd06Kvjw7g4I0wm3orc9Fif4ftIN08uFI
v6HVGAjpQfU1c4zI8OyAO2/Sf+AzS3A4EgYKW6ifBmhsyURhamcu3L7d9Vr3/EyF
SLVW95k3qLe4vLUuVLOc+bVzSdCQjSQPmJlQDZZ0Jt8m3cfDjy/nDbSvBjPJknjX
LjsIBtiil5Ekb6U=
-----END CERTIFICATE-----
`))

var keyPEMPKCS8RSA = bytes.NewReader([]byte(`
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCl5diaKyaGVYl5
9SoMN8jsJb5nZ5Pumqrs6pst2ZGFrPxCXP5DkSJPemVzvJjFxIKH+pFcold4kMmz
pTBW+XB83UhXR/lSnbrzVSw8m0OVlv3wYnSWuwRg7VAhUmkgVfTw9PHTgUNVUlpu
WihgVoZb4v552CdlTH8t6IH1Akgn/mmI+yuPs/AUmMxKGiI0d8+a2EdkNxH81cQX
DgSoF3c2TTbdBtQD88gUFV6q4648yYbCQEGXAs0TQng/hb/+LWn708s5qW5ggOKQ
ZjO1TafEDrfsLU5QIEf63FgMS8R0GRyxbS+B6APzqivfIgsiLWUlwjsZOEyvTUVR
+Rlpm7+JAgMBAAECggEAEfHf0SVTwHomKcQELVgnaqvWgbbpgIjIbmIeMQJ0xEHm
84K9mi9rx68UpEVFPTc5a14GNT/2ODtpJf57UR0gNtF0zsQhSvd2znVrGI8u61Ju
236638cQ/S8OWNxiNLY3jYzhT6CO2P7Ue1VTQsB5Ph06q5FfCY0RwLSCwi7iATlO
OFK8kd5PTfl5GjB3luN7RHr5K5/DrrRDd0yR6epao1+M01HYUb6I2GUnsY/IRLXB
l7EkAi1Ig6xTy6buXv5I9yKWffBzuSpH0yCSdIH5DtxtM3A0bZbq0ienniqhr99z
g3UprnsDprQpfG2kB3dIuFkmiIMLFUE0b5sOrE1o1QKBgQDRTzLygnQ50SsBY39v
sxnBtRS2/Tzynk64+drff/nvlZmt37wzo1HNTKNum4WoW7tfs/f3vLOjW3EIoLEf
oJwuf9T7OK3iMZ4kuKfrsf08w2eBc2p73+acNEjaAI8gIXAhKxzCemmfOkwHGkhl
TPUo52PCpNMEOmdECJgIhp6CdwKBgQDK55eVXnhB73nQsOJ/Gs5SXidRnhY08o3B
EEUxj9H2gJc3RaLl31HlumiU2cJr16pKiblLbiR0Ceg0uNdewJBCQh+dri3dO6IZ
15WiSnCcFcwnRfj1jATupy1pQGprZEcj8AbJtM69EJ8szPiLGx8qq5PGy16LbyVt
61MwU9ZN/wKBgD6m50gh9mpMCwRqZP3pbV9HNcEkgjbZXhUObQ6TfxvQ+uRJ4UrP
qy+5rf3wvYxMkQSvmRzlthvCxk3f08T0zWs5xmXAbIQVeBHj2Be7+mJS10uvYYNc
3OmK2PewTSc/+xFil0Q7YhxQVeuWWW9BHu00fe8IaUWNudVqgR+kNBQ3AoGBAKjl
DfBvqnp39FYaZu6WSZeWd/QgOyvnmsdR28bdiFA/yZ9gf7AIrAsll1gPyx4pbr6M
1YhMLlvIw1jfY6ajc3EzyU1fZx34PX51TUDB5eqG2mD2hb0eyBw/XDV4QR0TY4Qu
j/fmYRBPfa+1Dk38TX0fROr87b3yzp0ofR6FKqXRAoGAcRtJcUjQHDShJdD6UtTp
090oNpZlFNimc6Ab7K80mbMo5vvvaK0ZC2zgO7qyrF9S5TRsAGWgzlTsB7IysgY2
i6g3H8u3LhGLMHRb7f9cbgbCuSdnl3lKl76B8F53NeDzJfffH9eDEKzSPLcEw2P3
pvDGXjiyopJQyh1Xj7d+2KY=
-----END PRIVATE KEY-----
`))

var keyPEMRSA = bytes.NewReader([]byte(`
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEApeXYmismhlWJefUqDDfI7CW+Z2eT7pqq7OqbLdmRhaz8Qlz+
Q5EiT3plc7yYxcSCh/qRXKJXeJDJs6UwVvlwfN1IV0f5Up2681UsPJtDlZb98GJ0
lrsEYO1QIVJpIFX08PTx04FDVVJablooYFaGW+L+edgnZUx/LeiB9QJIJ/5piPsr
j7PwFJjMShoiNHfPmthHZDcR/NXEFw4EqBd3Nk023QbUA/PIFBVequOuPMmGwkBB
lwLNE0J4P4W//i1p+9PLOaluYIDikGYztU2nxA637C1OUCBH+txYDEvEdBkcsW0v
gegD86or3yILIi1lJcI7GThMr01FUfkZaZu/iQIDAQABAoIBABHx39ElU8B6JinE
BC1YJ2qr1oG26YCIyG5iHjECdMRB5vOCvZova8evFKRFRT03OWteBjU/9jg7aSX+
e1EdIDbRdM7EIUr3ds51axiPLutSbtt+ut/HEP0vDljcYjS2N42M4U+gjtj+1HtV
U0LAeT4dOquRXwmNEcC0gsIu4gE5TjhSvJHeT035eRowd5bje0R6+Sufw660Q3dM
kenqWqNfjNNR2FG+iNhlJ7GPyES1wZexJAItSIOsU8um7l7+SPciln3wc7kqR9Mg
knSB+Q7cbTNwNG2W6tInp54qoa/fc4N1Ka57A6a0KXxtpAd3SLhZJoiDCxVBNG+b
DqxNaNUCgYEA0U8y8oJ0OdErAWN/b7MZwbUUtv088p5OuPna33/575WZrd+8M6NR
zUyjbpuFqFu7X7P397yzo1txCKCxH6CcLn/U+zit4jGeJLin67H9PMNngXNqe9/m
nDRI2gCPICFwISscwnppnzpMBxpIZUz1KOdjwqTTBDpnRAiYCIaegncCgYEAyueX
lV54Qe950LDifxrOUl4nUZ4WNPKNwRBFMY/R9oCXN0Wi5d9R5bpolNnCa9eqSom5
S24kdAnoNLjXXsCQQkIfna4t3TuiGdeVokpwnBXMJ0X49YwE7qctaUBqa2RHI/AG
ybTOvRCfLMz4ixsfKquTxstei28lbetTMFPWTf8CgYA+pudIIfZqTAsEamT96W1f
RzXBJII22V4VDm0Ok38b0PrkSeFKz6svua398L2MTJEEr5kc5bYbwsZN39PE9M1r
OcZlwGyEFXgR49gXu/piUtdLr2GDXNzpitj3sE0nP/sRYpdEO2IcUFXrlllvQR7t
NH3vCGlFjbnVaoEfpDQUNwKBgQCo5Q3wb6p6d/RWGmbulkmXlnf0IDsr55rHUdvG
3YhQP8mfYH+wCKwLJZdYD8seKW6+jNWITC5byMNY32Omo3NxM8lNX2cd+D1+dU1A
weXqhtpg9oW9HsgcP1w1eEEdE2OELo/35mEQT32vtQ5N/E19H0Tq/O298s6dKH0e
hSql0QKBgHEbSXFI0Bw0oSXQ+lLU6dPdKDaWZRTYpnOgG+yvNJmzKOb772itGQts
4Du6sqxfUuU0bABloM5U7AeyMrIGNouoNx/Lty4RizB0W+3/XG4GwrknZ5d5Spe+
gfBedzXg8yX33x/XgxCs0jy3BMNj96bwxl44sqKSUModV4+3ftim
-----END RSA PRIVATE KEY-----
`))

var keyCSR = bytes.NewReader([]byte(`
-----BEGIN CERTIFICATE REQUEST-----
MIICozCCAYsCAQAwXjELMAkGA1UEBhMCQVUxGDAWBgNVBAgMD1NvdXRoIEF1c3Ry
YWxpYTERMA8GA1UEBwwIQWRlbGFpZGUxDDAKBgNVBAoMA0NhdDEUMBIGA1UEAwwL
anVzdFNvbWVHdXkwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCl5dia
KyaGVYl59SoMN8jsJb5nZ5Pumqrs6pst2ZGFrPxCXP5DkSJPemVzvJjFxIKH+pFc
old4kMmzpTBW+XB83UhXR/lSnbrzVSw8m0OVlv3wYnSWuwRg7VAhUmkgVfTw9PHT
gUNVUlpuWihgVoZb4v552CdlTH8t6IH1Akgn/mmI+yuPs/AUmMxKGiI0d8+a2Edk
NxH81cQXDgSoF3c2TTbdBtQD88gUFV6q4648yYbCQEGXAs0TQng/hb/+LWn708s5
qW5ggOKQZjO1TafEDrfsLU5QIEf63FgMS8R0GRyxbS+B6APzqivfIgsiLWUlwjsZ
OEyvTUVR+Rlpm7+JAgMBAAGgADANBgkqhkiG9w0BAQsFAAOCAQEAjOxjfXqifW1B
pSv/dCkf8O5Y0pUy8K7sAR3qfjIkj+fFp58zsAhiazI1n2rF6elVBKypatXGnIQf
ixbg4J7JaTW/9HyRgEO0NcR2QsMmz0UwZP4YfnzCIKFrPNk162UfsnlTU8nDOoy9
Sb128BB2uSF5HY7+sgP1NW+ww/5B0sEVRuoxlfEqjkSAyNElWU9Hpj1/R75laqjv
lFTwg++a5H33sPeQd9pJpoSly9waqtgqSrfVeOwdiWMlweLSYmFzrX/WQ1Ewfv/a
kXbMfmvRWdARKmQ7DznvfKYDU9P3lBL3UOQpHJOrN70BvCMxye6ZzZrRhQCsoShq
7r5h2w6Hgw==
-----END CERTIFICATE REQUEST-----
`))

func TestNewCAFromReaders(t *testing.T) {
	if _, err := NewCAFromReaders(ca, keyPEMPKCS8RSA, ""); err != nil {
		t.Errorf("Failed to load CA with error %s", err)
	}
}

func TestCA_SignRequest(t *testing.T) {
	req, err := NewRequestFromReader(keyCSR)
	if err != nil {
		t.Fatalf("Failed to initialise CSR %s", err)
	}

	c, err := NewCAFromReaders(ca, keyPEMPKCS8RSA, "")
	if err != nil {
		t.Fatalf("Failed to load CA with error %s", err)
	}

	if err := c.SignRequest(req); err != nil {
		t.Errorf("Failed to sign request with error %s", err)
	}
}
